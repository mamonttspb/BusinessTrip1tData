<script>
  const WebApp = window.Telegram.WebApp;
  WebApp.ready();
  WebApp.expand();

  // Тема
  document.body.style.backgroundColor = WebApp.themeParams.bg_color || '';
  document.body.style.color = WebApp.themeParams.text_color || '';

  // Парсинг входных данных
  const params = new URLSearchParams(window.location.search);
  const startParam = WebApp.initDataUnsafe?.start_param || params.get('data');
  let data = {};
  try {
    const rawData = JSON.parse(decodeURIComponent(startParam || '{}'));
    let output = rawData.output;
    if (typeof output === 'string') {
      try { output = JSON.parse(output); } catch {}
    }
    data = {
      ...(output || {}),
      real_name_file: rawData.real_name_file,
      page: rawData.page,
    };
  } catch {
    data = {};
  }

  // Заголовок формы
  function setFormTitle() {
    const el = document.getElementById('formTitle');
    let title = 'Данные документа';
    if (data.real_name_file) title = data.real_name_file.replace(/\.[^/.]+$/, '');
    if (data.page) title += `, стр. № ${data.page}`;
    el.textContent = title;
    document.title = title;
  }
  setFormTitle();

  // Хелперы
  function normalizeNum(s) {
    return s == null ? '' : String(s).replace(/\s/g, '').replace(',', '.');
  }
  function formatDate(d) {
    if (!d) return '';
    if (/\d{2}\.\d{2}\.\d{4}/.test(d)) return d;
    const m = d.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m}.${m}.${m}` : d;[1][2][3]
  }

  // Подготовка значений
  if (Array.isArray(data.cost_category)) {
    data.cost_category = data.cost_category.map(o => {
      const [k,v] = Object.entries(o) || ['', ''];
      return { [k]: normalizeNum(v) };
    });
  }
  data.total = normalizeNum(data['total, RUB'] || data['total, руб'] || data.total);

  const form = document.getElementById('docForm');
  const errorDiv = document.getElementById('error');
  if (data.error) errorDiv.textContent = `ВНИМАНИЕ: ${data.error}`;

  function addField(label, val='', name, type='text') {
    const div = document.createElement('div');
    div.className = 'field';
    const lbl = document.createElement('label');
    lbl.textContent = label;
    const input = (type==='textarea' ? document.createElement('textarea') : document.createElement('input'));
    if (type!=='textarea') input.type = type;
    input.name = name;
    input.value = val;
    div.append(lbl, input);
    form.append(div);
    return input;
  }

  function computeAndFillTotal() {
    const sums = Array.from(document.querySelectorAll('input[name="cost_sum"]'))
      .map(i => parseFloat(i.value) || 0);
    const t = sums.reduce((a,b)=>a+b,0).toFixed(2);
    const el = document.getElementById('totalInput');
    if (el) el.value = t;
  }

  function renderCosts(costs) {
    const c = document.createElement('div');
    c.className = 'field';
    const lbl = document.createElement('label');
    lbl.textContent = 'Затраты';
    c.append(lbl);
    form.append(c);

    function updDel() {
      const rows = c.querySelectorAll('.cost-row');
      rows.forEach(r => {
        r.querySelector('.del-btn').style.visibility = rows.length>1 ? 'visible' : 'hidden';
      });
    }

    function addRow(desc='', sum='') {
      const r = document.createElement('div');
      r.className = 'cost-row';
      const t = document.createElement('textarea');
      t.name='cost_desc'; t.placeholder='Описание'; t.value=desc;
      const num = document.createElement('input');
      num.type='number'; num.step='0.01'; num.name='cost_sum'; num.value=sum;
      num.oninput = computeAndFillTotal;
      const plus = document.createElement('button');
      plus.type='button'; plus.textContent='➕';
      plus.onclick = ()=>{ addRow(); updDel(); computeAndFillTotal(); };
      const del = document.createElement('button');
      del.type='button'; del.textContent='➖'; del.className='del-btn';
      del.onclick = ()=>{ r.remove(); updDel(); computeAndFillTotal(); };
      r.append(t, num, plus, del);
      c.append(r);
      updDel();
    }

    if (Array.isArray(costs) && costs.length) {
      costs.forEach(o=> {
        const [d,s] = Object.entries(o)||['',''];
        addRow(d,s);
      });
    } else addRow();
    computeAndFillTotal();
  }

  function addTotal() {
    const input = addField('Итого', data.total, 'total', 'number');
    input.id = 'totalInput';
    input.readOnly = true;
  }

  // Рендер полей в зависимости от типа
  switch (data.type_doc) {
    case 'cash_receipt':
      addField('Тип документа', 'кассовый чек', 'type_doc');
      addField('Дата покупки', formatDate(data.date_purchase), 'date_purchase', 'text');
      renderCosts(data.cost_category);
      addTotal();
      break;

    case 'itinerary_receipt':
      addField('Тип документа', 'маршрутная квитанция', 'type_doc');
      addField('Населенный пункт убытия', data.departure_city, 'departure_city');
      addField('Дата убытия', formatDate(data.departure_date), 'departure_date', 'text');
      addField('Населенный пункт прибытия', data.arrival_city, 'arrival_city');
      addField('Дата прибытия', formatDate(data.arrival_date), 'arrival_date', 'text');
      renderCosts(data.cost_category);
      addTotal();
      break;

    case 'hotel_voucher':
      addField('Тип документа', 'ваучер проживания в отеле', 'type_doc');
      addField('Населенный пункт', data.arrival_city, 'city');
      addField('Дата заселения', formatDate(data.arrival_date), 'check_in_date', 'text');
      addField('Дата выезда', formatDate(data.departure_date), 'check_out_date', 'text');
      break;

    default:
      addField('Тип документа', data.type_doc === 'other' ? 'неизвестен' : (data.type_doc || ''), 'type_doc');
      addField('Населенный пункт убытия', data.departure_city, 'departure_city');
      addField('Дата убытия', formatDate(data.departure_date), 'departure_date', 'text');
      addField('Населенный пункт прибытия', data.arrival_city, 'arrival_city');
      addField('Дата прибытия', formatDate(data.arrival_date), 'arrival_date', 'text');
      renderCosts(data.cost_category);
      addTotal();
      break;
  }

  // Кнопки
  document.getElementById('saveBtn').onclick = ()=> {
    const fd = {};
    new FormData(form).forEach((v,k)=>{
      if (k==='cost_desc'||k==='cost_sum') {
        fd.costs = fd.costs||[];
        if (k==='cost_desc') fd.costs.push({desc:v});
        else fd.costs[fd.costs.length-1].sum=v;
      } else fd[k]=v;
    });
    WebApp.sendData(JSON.stringify({action:'save_approval_doc',data:fd}));
  };
  document.getElementById('skipBtn').onclick = ()=> {
    WebApp.sendData(JSON.stringify({action:'skip_current_file'}));
  };
  document.getElementById('cancelBtn').onclick = ()=> {
    WebApp.sendData(JSON.stringify({action:'cancel_approval_doc'}));
    WebApp.close();
  };

  WebApp.onEvent('themeChanged', ()=> {
    document.body.style.backgroundColor = WebApp.themeParams.bg_color;
    document.body.style.color = WebApp.themeParams.text_color;
  });
</script>
