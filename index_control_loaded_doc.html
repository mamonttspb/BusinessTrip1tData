<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: var(--tg-theme-bg-color);
        color: var(--tg-theme-text-color);
      }
      
      .form-title {
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        color: var(--tg-theme-text-color);
        border-bottom: 2px solid var(--tg-theme-button-color, #0088cc);
        padding-bottom: 10px;
      }
      
      .field {
        margin-bottom: 15px;
      }
      .field label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        font-size: 16px;
      }
      input[type="text"],
      input[type="number"],
      input[type="date"],
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--tg-theme-button-color, #0088cc);
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box;
        background: var(--tg-theme-secondary-bg-color);
        color: var(--tg-theme-text-color);
      }
      input:invalid,
      textarea:invalid {
        border-color: #ff4444;
      }
      input:valid,
      textarea:valid {
        border-color: #00aa00;
      }
      textarea {
        height: 30vh;
        resize: vertical;
      }
      .cost-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 8px;
      }
      .cost-row textarea,
      .cost-row input {
        font-size: 14px;
      }
      .cost-row button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        margin-left: 6px;
        margin-top: 6px;
        color: var(--tg-theme-button-color, #0088cc);
      }
      .del-btn {
        visibility: hidden;
      }
      #buttons {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #buttons button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        box-sizing: border-box;
        font-weight: 500;
      }
      #saveBtn {
        background: var(--tg-theme-button-color, #0088cc);
        color: var(--tg-theme-button-text-color, #ffffff);
      }
      #skipBtn {
        background: #ff9500;
        color: #ffffff;
      }
      #cancelBtn {
        background: #ff4444;
        color: #ffffff;
      }
      #buttons button:active {
        opacity: 0.8;
      }
      #error {
        color: #ff4444;
        font-size: 14px;
        margin-bottom: 10px;
      }
    </style>
    <title>Данные документа</title>
  </head>
  <body>
    <div id="error"></div>
    <h1 id="formTitle" class="form-title">Данные документа</h1>
    <form id="docForm"></form>
    <div id="buttons">
      <button type="button" id="saveBtn">✅ Подтвердить корректность данных</button>
      <button type="button" id="skipBtn">☢ Не загружать текущий файл</button>
      <button type="button" id="cancelBtn">❌ Отменить загрузку данных</button>
    </div>

    <script>
      const WebApp = window.Telegram.WebApp;
      WebApp.ready();
      WebApp.expand();

      // Устанавливаем тему
      document.body.style.backgroundColor = WebApp.themeParams.bg_color || '';
      document.body.style.color = WebApp.themeParams.text_color || '';

      // Парсинг входных данных
      const params = new URLSearchParams(window.location.search);
      const startParam = WebApp.initDataUnsafe?.start_param || params.get('data');
      let data = {};
      try {
        const rawData = JSON.parse(decodeURIComponent(startParam || '{}'));
        
        // Если данные приходят в структуре { output: {...}, real_name_file: "...", page: "..." }
        if (rawData.output) {
          // Извлекаем данные из output и добавляем к ним real_name_file и page
          data = { ...rawData.output, real_name_file: rawData.real_name_file, page: rawData.page };
        } else {
          // Если данные приходят напрямую
          data = rawData;
        }
      } catch {
        data = {};
      }

      // Устанавливаем заголовок формы на основе real_name_file и page
      function setFormTitle() {
        console.log('Incoming data:', data);
        const titleElement = document.getElementById('formTitle');
        let title = 'Данные документа';
        
        if (data.real_name_file) {
          const fileName = data.real_name_file.replace(/\.[^/.]+$/, '');
          title = fileName;
        }
        
        if (data.page) {
          title += `, стр. № ${data.page}`;
        }
        
        titleElement.textContent = title;
        document.title = title;
      }

      // Вызов после парсинга данных
      setFormTitle();

      function normalizeNum(str) {
        if (str == null) return '';
        return String(str).replace(/\s/g, '').replace(',', '.');
      }
      function formatDate(d) {
        if (!d) return '';
        if (/\d{2}\.\d{2}\.\d{4}/.test(d)) return d;
        const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(d);
        if (!m) return d;
        const [, y, mm, dd] = m;
        return `${dd}.${mm}.${y}`;
      }

      if (Array.isArray(data.cost_category)) {
        data.cost_category = data.cost_category.map(obj => {
          const [desc, val] = Object.entries(obj)[0] || ['', ''];
          return { [desc]: normalizeNum(val) };
        });
      }
      if (data['total, RUB']) {
        data.total = normalizeNum(data['total, RUB']);
      } else if (data['total, руб']) {
        data.total = normalizeNum(data['total, руб']);
      } else if (data.total) {
        data.total = normalizeNum(data.total);
      } else {
        data.total = '';
      }

      const form = document.getElementById('docForm');
      const errorDiv = document.getElementById('error');
      if (data.error) {
        errorDiv.textContent = `ВНИМАНИЕ: ${data.error}`;
      }

      function addField(labelText, value = '', name, type = 'text') {
        const container = document.createElement('div');
        container.className = 'field';
        const label = document.createElement('label');
        label.textContent = labelText;
        const input = type === 'textarea'
          ? document.createElement('textarea')
          : document.createElement('input');
        if (type !== 'textarea') input.type = type;
        input.name = name;
        input.value = value;
        if (['date_purchase','departure_date','arrival_date','check_in_day','check_out_date'].includes(name)) {
          input.type = 'date';
          input.value = value ? value.split('.').reverse().join('-') : '';
        }
        if (name === 'total') {
          input.id = 'totalInput';
          input.readOnly = true;
        }
        container.append(label, input);
        form.append(container);
        return input;
      }

      function computeAndFillTotal() {
        const sums = Array.from(document.querySelectorAll('input[name="cost_sum"]'))
          .map(i => parseFloat(i.value) || 0);
        const t = sums.reduce((a,b) => a+b, 0).toFixed(2);
        const el = document.getElementById('totalInput');
        if (el) el.value = t;
        return t;
      }

      function renderCosts(costs) {
        const container = document.createElement('div');
        container.className = 'field';
        const label = document.createElement('label');
        label.textContent = 'Затраты';
        container.append(label);
        form.append(container);

        function updateDeleteButtons() {
          const rows = container.querySelectorAll('.cost-row');
          rows.forEach(row => {
            const delBtn = row.querySelector('.del-btn');
            delBtn.style.visibility = rows.length>1 ? 'visible' : 'hidden';
          });
        }

        function addCostRow(desc='', sum='') {
          const row = document.createElement('div');
          row.className = 'cost-row';

          const descInput = document.createElement('textarea');
          descInput.name='cost_desc';
          descInput.placeholder='Описание';
          descInput.value=desc;

          const sumInput = document.createElement('input');
          sumInput.type='number';
          sumInput.step='0.01';
          sumInput.name='cost_sum';
          sumInput.value=sum;
          sumInput.oninput=computeAndFillTotal;

          const addBtn = document.createElement('button');
          addBtn.type='button';
          addBtn.textContent='➕';
          addBtn.onclick = ()=>{
            addCostRow();
            updateDeleteButtons();
            computeAndFillTotal();
          };

          const delBtn = document.createElement('button');
          delBtn.type='button';
          delBtn.textContent='➖';
          delBtn.className='del-btn';
          delBtn.onclick = ()=>{
            row.remove();
            updateDeleteButtons();
            computeAndFillTotal();
          };

          row.append(descInput, sumInput, addBtn, delBtn);
          container.append(row);
          updateDeleteButtons();
        }

        if (Array.isArray(costs) && costs.length) {
          costs.forEach(obj=>{
            const [d,s] = Object.entries(obj)[0]||['',''];
            addCostRow(d,s);
          });
        } else {
          addCostRow();
        }
        computeAndFillTotal();
      }

      function addTotalField() {
        addField('Итого', data.total, 'total', 'number');
      }

      switch(data.type_doc) {
        case 'cash_receipt':
          addField('Тип документа','кассовый чек','type_doc');
          addField('Дата покупки', data.date_purchase,'date_purchase','date');
          renderCosts(data.cost_category);
          addTotalField();
          if(!data.total) computeAndFillTotal();
          break;
        case 'itinerary_receipt':
          addField('Тип документа','маршрутная квитанция','type_doc');
          addField('Населенный пункт убытия', data.departure_city,'departure_city');
          addField('Дата убытия', data.departure_date,'departure_date','date');
          addField('Населенный пункт прибытия', data.arrival_city,'arrival_city');
          addField('Дата прибытия', data.arrival_date,'arrival_date','date');
          renderCosts(data.cost_category);
          addTotalField();
          if(!data.total) computeAndFillTotal();
          break;
        case 'boarding_pass':
          addField('Тип документа','посадочный талон','type_doc');
          addField('Населенный пункт убытия', data.departure_city,'departure_city');
          addField('Населенный пункт прибытия', data.arrival_city,'arrival_city');
          break;
        case 'hotel_voucher':
          addField('Тип документа','ваучер проживания в отеле','type_doc');
          addField('Населенный пункт', data.departure_city,'departure_city');
          addField('Дата заселения', data.arrival_date,'arrival_date','date');
          addField('Дата выезда', data.departure_date,'departure_date','date');
          break;
        default:
          addField('Тип документа', data.type_doc==='other'?'неизвестен':data.type_doc,'type_doc');
          addField('Населенный пункт убытия', data.departure_city,'departure_city');
          addField('Дата убытия', data.departure_date,'departure_date','date');
          addField('Населенный пункт прибытия', data.arrival_city,'arrival_city');
          addField('Дата прибытия', data.arrival_date,'arrival_date','date');
          renderCosts(data.cost_category);
          addTotalField();
          if(!data.total) computeAndFillTotal();
      }

      document.getElementById('saveBtn').onclick = () => {
        const formData = {};
        new FormData(form).forEach((v,k)=>{
          if(k==='cost_desc'||k==='cost_sum') {
            formData.costs=formData.costs||[];
            if(k==='cost_desc') formData.costs.push({desc:v});
            else formData.costs[formData.costs.length-1].sum=v;
          } else formData[k]=v;
        });
        formData.total=document.getElementById('totalInput')?.value||formData.total||'';
        WebApp.sendData(JSON.stringify({action:'save_approval_doc',data:formData}));
      };
      document.getElementById('skipBtn').onclick = () => {
        WebApp.sendData(JSON.stringify({action:'skip_current_file'}));
      };
      document.getElementById('cancelBtn').onclick = () => {
        WebApp.sendData(JSON.stringify({action:'cancel_approval_doc'}));
        WebApp.close();
      };
      WebApp.onEvent('themeChanged',()=>{
        document.body.style.backgroundColor=WebApp.themeParams.bg_color;
        document.body.style.color=WebApp.themeParams.text_color;
      });
    </script>
  </body>
</html>
