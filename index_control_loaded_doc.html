<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
     ...
    </style>
    <title>Данные документа</title>
  </head>
  <body>
    <div id="error"></div>
    <h1 id="formTitle" class="form-title">Данные документа</h1>
    <form id="docForm"></form>
    <div id="buttons">
      <button type="button" id="saveBtn">✅ Подтвердить корректность данных</button>
      <button type="button" id="skipBtn">☢ Не загружать текущий файл</button>
      <button type="button" id="cancelBtn">❌ Отменить загрузку данных</button>
    </div>

    <script>
      const WebApp = window.Telegram.WebApp;
      WebApp.ready();
      WebApp.expand();
    
      // Получаем параметр data из URL или Telegram initData
      const params = new URLSearchParams(window.location.search);
      const rawParam = WebApp.initDataUnsafe?.start_param || params.get('data') || '{}';
    
      // Функция безопасного многократного разбора JSON
      function safeParse(jsonStr) {
        let result = jsonStr;
        try { result = JSON.parse(result); } catch {}
        if (typeof result === 'string') {
          try { result = JSON.parse(result); } catch {}
        }
        return result;
      }
    
      // ======= НИЖЕ – универсальное декодирование и парсинг =======
      let payload = {};
      if (rawParam) {
        // 1) Попытка распарсить напрямую
        try {
          payload = safeParse(rawParam);
        } catch {}
        // 2) Если нет поля output – пробуем decodeURIComponent
        if (
          !payload ||
          typeof payload !== 'object' ||
          !('output' in payload)
        ) {
          try {
            const decoded = decodeURIComponent(rawParam);
            payload = safeParse(decoded);
          } catch {}
        }
      }
      // ======= /универсальное декодирование и парсинг =======
    
      // payload должен содержать { output, real_name_file, page }
      const { output, real_name_file, page } = payload;
      // output может быть объектом или строкой JSON
      const data = {
        ...(typeof output === 'object' && output !== null
            ? output
            : safeParse(output || '{}')),
        real_name_file,
        page,
      };
    
      // Далее – ваши существующие функции renderCosts, normalizeNum, formatDate и т.д.
    
      function setFormTitle() {
        const el = document.getElementById('formTitle');
        let title = 'Данные документа';
        if (data.real_name_file) {
          title = data.real_name_file.replace(/\.[^/.]+$/, '');
        }
        if (data.page && Number(data.page) > 0) {
          title += `, стр. № ${data.page}`;
        }
        el.textContent = title;
        document.title = title;
      }
    
      setFormTitle();
    
      function normalizeNum(s) {
        return s == null
          ? ''
          : String(s)
              .replace(/\s/g, '')
              .replace(',', '.')
              .replace(/[^0-9.]/g, '');
      }
      function formatDate(d) {
        if (!d) return '';
        if (/\d{2}\.\d{2}\.\d{4}/.test(d)) return d;
        const m = d.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        return m ? `${m[3]}.${m[2]}.${m[1]}` : d;
      }
    
      if (Array.isArray(data.cost_category)) {
        data.cost_category = data.cost_category.map(o => {
          const [k, v] = Object.entries(o)[0] || ['', ''];
          return { [k]: normalizeNum(v) };
        });
      }
      data.total = normalizeNum(
        data['total, RUB'] ||
        data['total, руб'] ||
        data.total
      );
    
      const form = document.getElementById('docForm');
      const errorDiv = document.getElementById('error');
      if (data.error) errorDiv.textContent = `ВНИМАНИЕ: ${data.error}`;
    
      function addField(label, val = '', name, type = 'text') {
        const div = document.createElement('div');
        div.className = 'field';
        const lbl = document.createElement('label');
        lbl.textContent = label;
        const input = type === 'textarea'
          ? document.createElement('textarea')
          : document.createElement('input');
        if (type !== 'textarea') input.type = type;
        input.name = name;
        input.value = val;
        if (['date_purchase','departure_date','arrival_date','check_in_date','check_out_date']
            .includes(name)) {
          input.type = 'date';
          input.value = val ? val.split('.').reverse().join('-') : '';
        }
        if (name === 'total') {
          input.id = 'totalInput';
          input.readOnly = true;
        }
        div.append(lbl, input);
        form.append(div);
        return input;
      }
    
      function computeAndFillTotal() {
        const sums = Array.from(document.querySelectorAll('input[name="cost_sum"]'))
          .map(i => parseFloat(i.value) || 0);
        const t = sums.reduce((a, b) => a + b, 0).toFixed(2);
        const el = document.getElementById('totalInput');
        if (el) el.value = t;
      }
    
      function renderCosts(costs) {
        const c = document.createElement('div');
        c.className = 'field';
        const lbl = document.createElement('label');
        lbl.textContent = 'Затраты';
        c.append(lbl);
        form.append(c);
      
        function updDel() {
          const rows = c.querySelectorAll('.cost-row');
          rows.forEach(r => {
            const delBtn = r.querySelector('.del-btn');
            if (data.type_doc === 'other') {
              delBtn.style.visibility = 'visible';
            } else {
              delBtn.style.visibility = rows.length > 1 ? 'visible' : 'hidden';
            }
          });
        }
      
        function addRow(desc = '', sum = '') {
          const r = document.createElement('div');
          r.className = 'cost-row';
          const t = document.createElement('textarea');
          t.name = 'cost_desc';
          t.placeholder = 'Описание';
          t.value = desc;
          const num = document.createElement('input');
          num.type = 'number';
          num.step = '0.01';
          num.name = 'cost_sum';
          num.value = sum;
          num.oninput = computeAndFillTotal;
          const plus = document.createElement('button');
          plus.type = 'button';
          plus.textContent = '➕';
          plus.onclick = () => {
            addRow();
            updDel();
            computeAndFillTotal();
          };
          const del = document.createElement('button');
          del.type = 'button';
          del.textContent = '➖';
          del.className = 'del-btn';
          del.onclick = () => {
            r.remove();
            updDel();
            computeAndFillTotal();
          };
          r.append(t, num, plus, del);
          c.append(r);
          updDel();
        }
      
        if (Array.isArray(costs) && costs.length) {
          costs.forEach(o => {
            const [d, s] = Object.entries(o)[0] || ['', ''];
            addRow(d, s);
          });
        } else addRow();
        computeAndFillTotal();
      }
    
      function addTotal() {
        addField('Итого', data.total, 'total', 'number');
      }
    
      function renderDynamicFields() {
        const fieldTypes = [
          { label: 'Дата покупки', name: 'date_purchase', type: 'date', value: formatDate(data.date_purchase) },
          { label: 'Дата убытия', name: 'departure_date', type: 'date', value: formatDate(data.departure_date) },
          { label: 'Дата прибытия', name: 'arrival_date', type: 'date', value: formatDate(data.arrival_date) },
          { label: 'Населённый пункт убытия', name: 'departure_city', type: 'text', value: data.departure_city || '' },
          { label: 'Населённый пункт прибытия', name: 'arrival_city', type: 'text', value: data.arrival_city || '' }
        ];
    
        fieldTypes.forEach(fieldType => {
          const c = document.createElement('div');
          c.className = 'field';
          const lbl = document.createElement('label');
          lbl.textContent = fieldType.label;
          c.append(lbl);
          form.append(c);
    
          function addRow(value = '') {
            const r = document.createElement('div');
            r.className = 'dynamic-field-row';
            const input = document.createElement('input');
            input.type = fieldType.type;
            input.name = fieldType.name;
            input.value = value;
            if (fieldType.type === 'date' && value) {
              input.value = value.split('.').reverse().join('-');
            }
            const plus = document.createElement('button');
            plus.type = 'button';
            plus.textContent = '➕';
            plus.onclick = () => { addRow(); };
            const del = document.createElement('button');
            del.type = 'button';
            del.textContent = '➖';
            del.onclick = () => { r.remove(); };
            r.append(input, plus, del);
            c.append(r);
          }
    
          if (fieldType.value) addRow(fieldType.value);
          else addRow();
        });
      }
    
      function renderDynamicTotal() {
        const c = document.createElement('div');
        c.className = 'field';
        const lbl = document.createElement('label');
        lbl.textContent = 'Итого';
        c.append(lbl);
        form.append(c);
    
        function addRow(value = '') {
          const r = document.createElement('div');
          r.className = 'dynamic-field-row';
          const input = document.createElement('input');
          input.type = 'number';
          input.step = '0.01';
          input.name = 'total';
          input.value = value;
          const plus = document.createElement('button');
          plus.type = 'button';
          plus.textContent = '➕';
          plus.onclick = () => { addRow(); };
          const del = document.createElement('button');
          del.type = 'button';
          del.textContent = '➖';
          del.onclick = () => { r.remove(); };
          r.append(input, plus, del);
          c.append(r);
        }
    
        addRow(data.total || '');
      }
    
      switch (data.type_doc) {
        case 'cash_receipt':
          addField('Тип документа', 'кассовый чек', 'type_doc');
          addField('Дата покупки', formatDate(data.date_purchase), 'date_purchase');
          renderCosts(data.cost_category);
          addTotal();
          computeAndFillTotal();
          break;
    
        case 'itinerary_receipt':
          addField('Тип документа', 'маршрутная квитанция', 'type_doc');
          addField('Населённый пункт убытия', data.departure_city, 'departure_city');
          addField('Дата убытия', formatDate(data.departure_date), 'departure_date');
          addField('Населённый пункт прибытия', data.arrival_city, 'arrival_city');
          addField('Дата прибытия', formatDate(data.arrival_date), 'arrival_date');
          renderCosts(data.cost_category);
          addTotal();
          computeAndFillTotal();
          break;
    
        case 'hotel_voucher':
          addField('Тип документа', 'ваучер проживания в отеле', 'type_doc');
          addField('Населённый пункт', data.arrival_city, 'arrival_city');
          addField('Дата заселения', formatDate(data.arrival_date), 'arrival_date');
          addField('Дата выезда', formatDate(data.departure_date), 'departure_date');
          break;
    
        case 'boarding_pass':
          addField('Тип документа', 'посадочный талон', 'type_doc');
          addField('Населённый пункт отправления', data.departure_city, 'departure_city');
          addField('Дата отправления', formatDate(data.departure_date), 'departure_date');
          addField('Населённый пункт прибытия', data.arrival_city, 'arrival_city');
          break;
    
        default:
          addField('Тип документа', 'неизвестен', 'type_doc');
          renderDynamicFields();
          renderCosts(data.cost_category);
          renderDynamicTotal();
          break;
      }
    
      document.getElementById('saveBtn').onclick = () => {
        const fd = {};
        new FormData(form).forEach((v, k) => {
          if (k === 'cost_desc' || k === 'cost_sum') {
            fd.costs = fd.costs || [];
            if (k === 'cost_desc') fd.costs.push({ desc: v });
            else fd.costs[fd.costs.length - 1].sum = v;
          } else {
            if (fd[k]) {
              if (!Array.isArray(fd[k])) fd[k] = [fd[k]];
              fd[k].push(v);
            } else {
              fd[k] = v;
            }
          }
        });
        WebApp.sendData(JSON.stringify({ action: 'save_approval_doc', data: fd }));
      };
      document.getElementById('skipBtn').onclick = () => {
        WebApp.sendData(JSON.stringify({ action: 'skip_current_file' }));
      };
      document.getElementById('cancelBtn').onclick = () => {
        WebApp.sendData(JSON.stringify({ action: 'cancel_approval_doc' }));
        WebApp.close();
      };
      WebApp.onEvent('themeChanged', () => {
        document.body.style.backgroundColor = WebApp.themeParams.bg_color;
        document.body.style.color = WebApp.themeParams.text_color;
      });
    </script>
  </body>
</html>
