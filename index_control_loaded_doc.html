<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    .field { margin-bottom: 10px; }
    .field label { display: block; margin-bottom: 4px; font-weight: bold; }
    .field input[type="text"], .field input[type="number"], .field input[type="date"] {
      width: 100%; padding: 6px; box-sizing: border-box;
    }
    .cost-row { display: flex; align-items: center; margin-bottom: 6px; }
    .cost-row input { margin-right: 4px; }
    .cost-row button { background: none; border: none; font-size: 18px; cursor: pointer; margin-left: 4px; }
    #buttons { margin-top: 20px; display: flex; justify-content: space-between; }
    #buttons button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    #error { color: red; font-weight: bold; margin-bottom: 10px; }
  </style>
  <title>Данные документа</title>
</head>
<body>
  <div id="error"></div>
  <form id="docForm"></form>
  <div id="buttons">
    <button type="button" id="saveBtn">✅ Сохранить данные</button>
    <button type="button" id="cancelBtn">❌ Отменить загрузку данных</button>
  </div>

  <script>
    const WebApp = window.Telegram.WebApp;
    WebApp.ready();

    // Прочитать JSON из start_param или URL
    const params = new URLSearchParams(window.location.search);
    const startParam = WebApp.initDataUnsafe?.start_param || params.get('data');
    let data = {};
    try {
      data = JSON.parse(decodeURIComponent(startParam || '{}'));
    } catch (e) {
      console.error('Невалидный JSON', e);
    }

    // Преобразование даты YYYY-MM-DD → DD.MM.YYYY
    function formatDate(d) {
      if (!d) return '';
      const [y, m, day] = d.split('-');
      return `${day}.${m}.${y}`;
    }

    const form = document.getElementById('docForm');
    const errorDiv = document.getElementById('error');

    // Показать error если есть
    if (data.error) {
      errorDiv.textContent = `ВНИМАНИЕ: ${data.error}`;
    }

    // Общая функция рендеринга полей
    function addField(labelText, value='', name, type='text') {
      const container = document.createElement('div');
      container.className = 'field';
      const label = document.createElement('label');
      label.textContent = labelText;
      const input = document.createElement('input');
      input.type = type;
      input.name = name;
      input.value = value;
      container.append(label, input);
      form.append(container);
    }

    // Рендер списка затрат
    function renderCosts(costs) {
      const container = document.createElement('div');
      container.className = 'field';
      const label = document.createElement('label');
      label.textContent = 'Затраты';
      container.append(label);
      form.append(container);

      function addCostRow(desc='', sum='') {
        const row = document.createElement('div');
        row.className = 'cost-row';
        const descInput = document.createElement('input');
        descInput.type = 'text';
        descInput.placeholder = 'Описание';
        descInput.value = desc;
        descInput.name = 'cost_desc';
        const sumInput = document.createElement('input');
        sumInput.type = 'number';
        sumInput.step = '0.01';
        sumInput.placeholder = 'Сумма';
        sumInput.value = sum;
        sumInput.name = 'cost_sum';
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.textContent = '➕';
        addBtn.title = 'Добавить строку ниже';
        addBtn.onclick = () => addCostRow();
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.textContent = '➖';
        delBtn.title = 'Удалить текущую строку';
        delBtn.onclick = () => row.remove();
        row.append(descInput, sumInput, addBtn, delBtn);
        container.append(row);
      }

      if (Array.isArray(costs) && costs.length) {
        costs.forEach(obj => {
          const [desc, sum] = Object.entries(obj)[0];
          addCostRow(desc, sum);
        });
      } else {
        addCostRow();
      }
    }

    // Основной рендер
    switch (data.type_doc) {
      case 'cash_receipt':
        addField('Тип документа', 'кассовый чек', 'type_doc');
        addField('Дата покупки', formatDate(data.date_purchase), 'date_purchase', 'text');
        renderCosts(data.cost_category);
        addField('Итого', data['total, руб'], 'total', 'number');
        break;

      case 'itinerary_receipt':
        addField('Тип документа', 'маршрутная квитанция', 'type_doc');
        addField('Населенный пункт убытия', data.departure_city, 'departure_city');
        addField('Дата убытия', formatDate(data.departure_date), 'departure_date', 'text');
        addField('Населенный пункт прибытия', data.arrival_city, 'arrival_city');
        addField('Дата прибытия', formatDate(data.arrival_date), 'arrival_date', 'text');
        renderCosts(data.cost_category);
        addField('Итого', data['total, RUB'], 'total', 'number');
        break;

      case 'hotel_voucher':
        addField('Тип документа', 'ваучер проживания в отеле', 'type_doc');
        addField('Населенный пункт', data.city, 'city');
        addField('Дата заселения', formatDate(data.check_in_day), 'check_in_day', 'text');
        addField('Дата выезда', formatDate(data.check_out_date), 'check_out_date', 'text');
        break;

      case 'other':
      default:
        addField('Тип документа', data.type_doc === 'other' ? 'неизвестен' : data.type_doc, 'type_doc');
        addField('Населенный пункт убытия', data.departure_city, 'departure_city');
        addField('Дата убытия', formatDate(data.departure_date), 'departure_date', 'text');
        addField('Населенный пункт прибытия', data.arrival_city, 'arrival_city');
        addField('Дата прибытия', formatDate(data.arrival_date), 'arrival_date', 'text');
        renderCosts(data.cost_category);
        addField('Итого', data.total, 'total', 'number');
        break;
    }

    // Кнопки
    document.getElementById('saveBtn').onclick = () => {
      const formData = {};
      new FormData(form).forEach((v, k) => {
        if (k === 'cost_desc' || k === 'cost_sum') {
          formData.costs = formData.costs || [];
          if (k === 'cost_desc') formData.costs.push({ desc: v });
          else formData.costs[formData.costs.length - 1].sum = v;
        } else {
          formData[k] = v;
        }
      });
      WebApp.sendData(JSON.stringify({ action: 'save', data: formData }));
    };
    document.getElementById('cancelBtn').onclick = () => {
      WebApp.sendData(JSON.stringify({ action: 'cancel' }));
      WebApp.close();
    };
  </script>
</body>
</html>