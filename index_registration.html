<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заявка на регистрацию</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }
        .form-container {
            max-width: 400px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:invalid {
            border-color: #ff4444;
        }
        input:valid {
            border-color: #00aa00;
        }
        .error-message {
            color: #ff4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Заявка на регистрацию</h1>
        <form id="regForm">
            <!-- Фамилия -->
            <div class="form-group">
                <label for="lastName">Фамилия *</label>
                <input type="text" id="lastName" name="lastName" required placeholder="Введите фамилию">
                <div class="error-message" id="lastName-error">Обязательное поле</div>
            </div>
            <!-- Имя -->
            <div class="form-group">
                <label for="firstName">Имя *</label>
                <input type="text" id="firstName" name="firstName" required placeholder="Введите имя">
                <div class="error-message" id="firstName-error">Обязательное поле</div>
            </div>
            <!-- Отчество -->
            <div class="form-group">
                <label for="middleName">Отчество *</label>
                <input type="text" id="middleName" name="middleName" required placeholder="Введите отчество">
                <div class="error-message" id="middleName-error">Обязательное поле</div>
            </div>
            <!-- Дата рождения -->
            <div class="form-group">
                <label for="birthDate">Дата рождения *</label>
                <input type="date" id="birthDate" name="birthDate" required>
                <div class="error-message" id="birthDate-error">Обязательное поле</div>
            </div>
            <!-- Личный Telegram -->
            <div class="form-group">
              <label for="personalTelegram">Личный Telegram *</label>
              <input
                type="text"
                id="personalTelegram"
                name="personalTelegram"
                required
                placeholder="https://t.me/username"
                pattern="^https://t\.me/[a-zA-Z0-9_]{2,}$"
              >
              <div class="error-message" id="personalTelegram-error">
                Введите в формате https://t.me/username (минимум 2 символа в нике, без пробелов)
              </div>
            </div>
            
            <!-- Телеграм руководителя -->
            <div class="form-group">
              <label for="manager">Telegram руководителя *</label>
              <input
                type="text"
                id="manager"
                name="manager"
                required
                placeholder="https://t.me/boss1;https://t.me/boss2"
                pattern="^https://t\.me/[a-zA-Z0-9_]{2,}(;https://t\.me/[a-zA-Z0-9_]{2,})*$"
              >
              <div class="error-message" id="manager-error">
                Формат: https://t.me/boss1;https://t.me/boss2 (без пробелов, минимум 2 символа в нике)
              </div>
            </div>
            </div>
            <!-- Отдел или проект -->
            <div class="form-group">
                <label for="department">Отдел или проект *</label>
                <input type="text" id="department" name="department" required placeholder="Введите отдел или проект">
                <div class="error-message" id="department-error">Обязательное поле</div>
            </div>
            <!-- Должность -->
            <div class="form-group">
                <label for="position">Должность *</label>
                <input type="text" id="position" name="position" required placeholder="Введите должность">
                <div class="error-message" id="position-error">Обязательное поле</div>
            </div>
        </form>
    </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
  document.body.style.color = tg.themeParams.text_color || '#000000';

  tg.MainButton.setParams({ text: "Отправить", color: "#cccccc", text_color: "#666666" });
  tg.MainButton.show();
  tg.MainButton.disable();

  if (tg.SecondaryButton && tg.SecondaryButton.show) {
    tg.SecondaryButton.setParams({
      text: "Отмена",
      color: "#d46a6a",
      text_color: "#ffffff",
      is_visible: true,
      is_active: true,
      position: "bottom"
    });
    tg.SecondaryButton.show();
    tg.onEvent('secondaryButtonClicked', () => {
      tg.sendData(JSON.stringify({ action: "cancel", user: tg.initDataUnsafe?.user }));
      tg.close();
    });
    if (tg.BackButton && tg.BackButton.hide) tg.BackButton.hide();
  } else {
    tg.BackButton.show();
    tg.BackButton.enable?.();
    tg.BackButton.onClick(() => {
      tg.sendData(JSON.stringify({ action: "cancel", user: tg.initDataUnsafe?.user }));
      tg.close();
    });
  }

  const form = document.getElementById('regForm');
  const fields = ['lastName','firstName','middleName','birthDate','personalTelegram','manager','department','position'];
  const errors = {};
  fields.forEach(id => errors[id] = document.getElementById(`${id}-error`));

  const TELEGRAM_PREFIX = 'https://t.me/';
  const USER_RE = /^[a-zA-Z0-9_]{2,}$/;

  function cleanUsername(raw) {
    if (!raw) return '';

    let s = String(raw);
    s = s.replace(/\s+/g, '');          // убираем пробелы
    s = s.replace(/^@+/, '');           // ведущие @

    // вырезаем t.me/ и https://t.me/ в любом месте, чтобы не было дублей
    s = s.replace(/https?:\/\/t\.me\//gi, '');
    s = s.replace(/t\.me\//gi, '');

    // оставляем только допустимые символы username
    s = s.replace(/[^a-zA-Z0-9_]/g, '');

    return s;
  }

  function setCaretMin(input, minPos) {
    if (document.activeElement !== input) return;
    const start = input.selectionStart ?? 0;
    const end = input.selectionEnd ?? 0;
    if (start < minPos || end < minPos) {
      input.setSelectionRange(minPos, minPos);
    }
  }

  function protectPrefix(input, prefix, allowRemoveTrailingBlock = false) {
    const minPos = prefix.length;

    input.addEventListener('keydown', (e) => {
      const start = input.selectionStart ?? 0;
      const end = input.selectionEnd ?? 0;

      // Нельзя удалять внутри закреплённого префикса
      if ((e.key === 'Backspace' || e.key === 'Delete')) {
        // Если выделение или курсор заходит в префикс — запрещаем
        if (start < minPos || end < minPos) {
          e.preventDefault();
          setCaretMin(input, minPos);
          return;
        }

        // Спец-логика для manager: если строка заканчивается на ";https://t.me/" (пустой добавленный босс),
        // то Backspace удаляет весь этот хвост (то самое "после ; можно удалить")
        if (allowRemoveTrailingBlock && e.key === 'Backspace') {
          const val = input.value || '';
          const suffix = ';' + TELEGRAM_PREFIX;
          if ((input.selectionStart === val.length) && val.endsWith(suffix)) {
            e.preventDefault();
            input.value = val.slice(0, -suffix.length);
            // caret в конец
            const pos = input.value.length;
            input.setSelectionRange(pos, pos);
          }
        }
      }
    });

    // Не даём поставить курсор внутрь префикса
    const guard = () => setCaretMin(input, minPos);
    input.addEventListener('focus', guard);
    input.addEventListener('click', guard);
    input.addEventListener('keyup', guard);
    input.addEventListener('mouseup', guard);
  }

  function sanitizePersonal() {
    const input = document.getElementById('personalTelegram');
    let v = (input.value || '').replace(/\s+/g, '');

    if (!v.startsWith(TELEGRAM_PREFIX)) {
      // если префикс повреждён/удалён — принудительно восстанавливаем
      v = TELEGRAM_PREFIX + v;
    }

    // убираем любые повторные вхождения префикса после начала
    v = TELEGRAM_PREFIX + v.slice(TELEGRAM_PREFIX.length).replace(/https?:\/\/t\.me\//gi, '').replace(/t\.me\//gi, '');

    // убираем @ и мусор в username
    const username = cleanUsername(v.slice(TELEGRAM_PREFIX.length));
    const newVal = TELEGRAM_PREFIX + username;

    if (input.value !== newVal) {
      input.value = newVal;
    }

    setCaretMin(input, TELEGRAM_PREFIX.length);
  }

  function sanitizeManager() {
    const input = document.getElementById('manager');
    let v = (input.value || '').replace(/\s+/g, '');

    // всегда должен быть первый закреплённый префикс
    if (!v.startsWith(TELEGRAM_PREFIX)) {
      v = TELEGRAM_PREFIX + v;
    }

    // запрет пробелов и ";;"
    v = v.replace(/;;+/g, ';');

    // если пользователь только что ввёл ';' в конец — сразу добавляем префикс
    if (v.endsWith(';')) {
      v += TELEGRAM_PREFIX;
    }

    // Нормализуем сегменты: всегда ";https://t.me/" между начальниками
    // Разбираем по ';' и приводим каждый кусок к "https://t.me/<username>"
    const partsRaw = v.split(';');

    const parts = partsRaw.map((pRaw, idx) => {
      let p = (pRaw || '').replace(/\s+/g, '');

      // для любого сегмента: убираем все варианты префикса, потом чистим username и добавляем наш
      // (это уберёт вставленное пользователем https://t.me/ во 2-м боссе и не даст дублей)
      if (p.startsWith(TELEGRAM_PREFIX)) p = p.slice(TELEGRAM_PREFIX.length);
      const username = cleanUsername(p);
      return TELEGRAM_PREFIX + username;
    });

    // Склеиваем обратно
    let newVal = parts.join(';');

    // Если пользователь вставил в середину "https://t.me/" руками — мы уже подчистили,
    // но дополнительно уберём любые дубли префикса после ';'
    newVal = newVal.replace(/(;https?:\/\/t\.me\/)+/gi, ';' + TELEGRAM_PREFIX);

    if (input.value !== newVal) {
      input.value = newVal;
    }

    setCaretMin(input, TELEGRAM_PREFIX.length);
  }

  function isValidPersonalTelegram(value) {
    if (!value) return false;
    if (/\s/.test(value)) return false;
    if (!value.startsWith(TELEGRAM_PREFIX)) return false;
    const username = value.slice(TELEGRAM_PREFIX.length);
    return USER_RE.test(username);
  }

  function isValidManagerTelegram(value) {
    if (!value) return false;
    if (/\s/.test(value)) return false;

    // не должно заканчиваться на ';' или на голый префикс последнего сегмента
    if (value.endsWith(';')) return false;
    if (value.endsWith(TELEGRAM_PREFIX)) return false;

    const parts = value.split(';');
    for (const part of parts) {
      if (!part.startsWith(TELEGRAM_PREFIX)) return false;
      const username = part.slice(TELEGRAM_PREFIX.length);
      if (!USER_RE.test(username)) return false;
    }
    return true;
  }

  function validateForm() {
    let valid = true;

    fields.forEach(id => {
      const input = document.getElementById(id);

      let fieldValid = input.checkValidity();

      if (id === 'personalTelegram') fieldValid = fieldValid && isValidPersonalTelegram(input.value);
      if (id === 'manager') fieldValid = fieldValid && isValidManagerTelegram(input.value);

      if (!fieldValid) {
        errors[id].style.display = 'block';
        input.style.borderColor = '#ff4444';
        valid = false;
      } else {
        errors[id].style.display = 'none';
        input.style.borderColor = '#00aa00';
      }
    });

    return valid;
  }

  function updateMainButton() {
    if (validateForm()) {
      tg.MainButton.enable();
      tg.MainButton.setParams({ color: '#28a745', text_color: '#ffffff' });
    } else {
      tg.MainButton.disable();
      tg.MainButton.setParams({ color: '#cccccc', text_color: '#666666' });
    }
  }

  // Общие слушатели: для всех кроме telegram-полей (чтобы не было двойной валидации до санитайза)
  fields
    .filter(id => id !== 'personalTelegram' && id !== 'manager')
    .forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener('input', updateMainButton);
      input.addEventListener('blur', updateMainButton);
    });

  window.addEventListener('focus', updateMainButton);
  form.addEventListener('submit', e => e.preventDefault());

  // Telegram inputs
  const personalInput = document.getElementById('personalTelegram');
  const managerInput = document.getElementById('manager');

  // Стартовые значения (показать закреплённый префикс)
  if (!personalInput.value) personalInput.value = TELEGRAM_PREFIX;
  if (!managerInput.value) managerInput.value = TELEGRAM_PREFIX;

  // Защита префикса
  protectPrefix(personalInput, TELEGRAM_PREFIX, false);
  protectPrefix(managerInput, TELEGRAM_PREFIX, true);

  // Санитайз + обновление
  personalInput.addEventListener('input', () => { sanitizePersonal(); updateMainButton(); });
  personalInput.addEventListener('blur', () => { sanitizePersonal(); updateMainButton(); });

  managerInput.addEventListener('input', () => { sanitizeManager(); updateMainButton(); });
  managerInput.addEventListener('blur', () => { sanitizeManager(); updateMainButton(); });

  // Первичная нормализация и отрисовка валидности
  sanitizePersonal();
  sanitizeManager();
  updateMainButton();

  tg.MainButton.onClick(() => {
    sanitizePersonal();
    sanitizeManager();

    if (!validateForm()) return;

    tg.MainButton.showProgress();

    const data = {};
    fields.forEach(id => data[id] = document.getElementById(id).value.trim());
    data.user = tg.initDataUnsafe?.user;

    // На выходе:
    // personalTelegram: https://t.me/username
    // manager: https://t.me/boss1;https://t.me/boss2;...
    tg.sendData(JSON.stringify(data));
    tg.close();
  });

  tg.onEvent('themeChanged', () => {
    document.body.style.backgroundColor = tg.themeParams.bg_color;
    document.body.style.color = tg.themeParams.text_color;
    updateMainButton();
  });
</script>
</body>
</html>
